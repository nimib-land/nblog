<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>drafts/easyess_js_ball.nim</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üê≥</text></svg>">
  <meta content="text/html; charset=utf-8" http-equiv="content-type">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link rel='stylesheet' href='https://unpkg.com/normalize.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/light.min.css">
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/pietroppeter/nimib/assets/atom-one-light.css'>
  <style>
.nb-box {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.nb-small {
  font-size: 0.8rem;
}
button.nb-small {
  float: right;
  padding: 2px;
  padding-right: 5px;
  padding-left: 5px;
}
section#source {
  display:none
}

.nb-output {
  line-height: 1.15;
}
</style>
  
  <script async defer data-domain="pietroppeter.github.io/nblog" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
<header>
<div class="nb-box">
  <span><a href="..">üè°</a></span>
  <span><code>drafts/easyess_js_ball.nim</code></span>
  <span><a href="https://github.com/pietroppeter/nblog"><svg aria-hidden="true" width="1.2em" height="1.2em" style="vertical-align: middle;" preserveAspectRatio="xMidYMid meet" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59c.4.07.55-.17.55-.38c0-.19-.01-.82-.01-1.49c-2.01.37-2.53-.49-2.69-.94c-.09-.23-.48-.94-.82-1.13c-.28-.15-.68-.52-.01-.53c.63-.01 1.08.58 1.23.82c.72 1.21 1.87.87 2.33.66c.07-.52.28-.87.51-1.07c-1.78-.2-3.64-.89-3.64-3.95c0-.87.31-1.59.82-2.15c-.08-.2-.36-1.02.08-2.12c0 0 .67-.21 2.2.82c.64-.18 1.32-.27 2-.27c.68 0 1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82c.44 1.1.16 1.92.08 2.12c.51.56.82 1.27.82 2.15c0 3.07-1.87 3.75-3.65 3.95c.29.25.54.73.54 1.48c0 1.07-.01 1.93-.01 2.2c0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z" fill="#000"></path></svg></a></span>
</div>
<hr>
</header><main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js" integrity="sha512-rCZdHNB0AePry6kAnKAVFMRfWPmUXSo+/vlGtrOUvhsxD0Punm/xWbEh+8vppPIOzKB9xnk42yCRZ5MD/jvvjQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<h2>Bouncing balls with an ECS</h2>
<p>Yesterday (Nov 14th 2022) I went to a very nice meetup
here in Milan (<a href="https://www.meetup.com/it-IT/open-source-saturday-milano/">Open Source Saturday Milano</a>).
You go there and you propose what you want to work on (some Open Source related activity).
People might be curious and tag along, or you might be interested in what others are doing.</p>
<p>I went with the idea of exploring Entity Component Systems (ECS), something I had never played with.
Initially the idea was to use <a href="https://github.com/rlipsc/polymorph">polymorph</a>.
I wanted to try and see if I was able to make it work with Nim's js backend.
Unfortunately it appears polymorph has <a href="https://github.com/rlipsc/polymorph/issues/21">some kind of issue with js backend</a>,
so the two poor souls that were curious about Nim, saw me fail miserably in the task
and generously helped debugging
(of course it took a while to understand the issue was with polymorph and not with the code I was writing).
At the end of morning I pivoted to try using <a href="https://github.com/EriKWDev/easyess">EasyEss</a>,
a polymorph's inspired ECS by the author of <a href="https://github.com/EriKWDev/nanim">Nanim</a>.
Indeed EasyEss works with Nim's js backend so the day was saved!</p>
<p>Today I managed to complete a very small demo.
Code is not really cleaned up and it is the first time I play with an ECS.
For drawing to canvas it uses code from <a href="bouncing_ball_p5js.html">bouncing_ball_p5js</a>,
but probably a better option would be to use something like <a href="https://github.com/planetis-m/jscanvas">jscanvas</a>.</p>
<p>To test the different components/systems I am showing 4 balls:</p>
<ul>
<li>one ball bounces with gravity directed towards the roof</li>
<li>a smaller ball bounces with gravity directed approximately towards the bottom right corner</li>
<li>a bigger ball does not feel gravity and slowly drifts bouncing off the walls</li>
<li>the biggest ball is subject to drag and stops after a few bounces
<ul>
<li>drag acts a bit weird when bouncing close to the walls</li>
</ul>
</li>
<li>the balls do not interact with each other</li>
</ul>
<p>To see the code, click on Show source button in the bottom right corner of the page.</p>

<script defer>/* Generated by the Nim Compiler v1.6.0 */
var framePtr = null;
var excHandler = 0;
var lastJSError = null;
var NTI469763559 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469763394 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469763229 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469763064 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762899 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762734 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762569 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI33555128 = {size: 0, kind: 17, base: null, node: null, finalizer: null};
var NTI469764933 = {size: 0, kind: 19, base: null, node: null, finalizer: null};
var NTI469764931 = {size: 0, kind: 19, base: null, node: null, finalizer: null};
var NTI469764929 = {size: 0, kind: 19, base: null, node: null, finalizer: null};
var NTI469764927 = {size: 0, kind: 19, base: null, node: null, finalizer: null};
var NTI33555083 = {size: 0, kind: 17, base: null, node: null, finalizer: null};
var NTI33555165 = {size: 0, kind: 22, base: null, node: null, finalizer: null};
var NTI33554440 = {size: 0,kind: 29,base: null,node: null,finalizer: null};
var NTI33555164 = {size: 0, kind: 22, base: null, node: null, finalizer: null};
var NTI33555112 = {size: 0, kind: 17, base: null, node: null, finalizer: null};
var NTI33555113 = {size: 0, kind: 17, base: null, node: null, finalizer: null};
var NTI33555124 = {size: 0, kind: 17, base: null, node: null, finalizer: null};
var NTI33554439 = {size: 0,kind: 28,base: null,node: null,finalizer: null};
var NTI469762226 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762222 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762218 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762214 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762210 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762206 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762202 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI469762198 = {size: 0, kind: 16, base: null, node: null, finalizer: null};
var NTI33554463 = {size: 0,kind: 42,base: null,node: null,finalizer: null};
var NTI469762194 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762193 = {size: 0, kind: 22, base: null, node: null, finalizer: null};
var NTI469762227 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469764925 = {size: 0, kind: 19, base: null, node: null, finalizer: null};
var NTI469762073 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762072 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762071 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762070 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762069 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762068 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI33554435 = {size: 0,kind: 36,base: null,node: null,finalizer: null};
var NTI469762067 = {size: 0, kind: 18, base: null, node: null, finalizer: null};
var NTI469762190 = {size: 0, kind: 14, base: null, node: null, finalizer: null};
var NTI469762191 = {size: 0, kind: 19, base: null, node: null, finalizer: null};
var NNI469762190 = {kind: 2, offset: 0, typ: null, name: null, len: 8, sons: {"0": {kind: 1, offset: 0, typ: NTI469762190, name: "ckExists", len: 0, sons: null}, 
"1": {kind: 1, offset: 1, typ: NTI469762190, name: "ckSize", len: 0, sons: null}, 
"2": {kind: 1, offset: 2, typ: NTI469762190, name: "ckPosition", len: 0, sons: null}, 
"3": {kind: 1, offset: 3, typ: NTI469762190, name: "ckVelocity", len: 0, sons: null}, 
"4": {kind: 1, offset: 4, typ: NTI469762190, name: "ckBounce", len: 0, sons: null}, 
"5": {kind: 1, offset: 5, typ: NTI469762190, name: "ckGravity", len: 0, sons: null}, 
"6": {kind: 1, offset: 6, typ: NTI469762190, name: "ckDrag", len: 0, sons: null}, 
"7": {kind: 1, offset: 7, typ: NTI469762190, name: "ckDraw", len: 0, sons: null}}};
NTI469762190.node = NNI469762190;
NTI469762191.base = NTI469762190;
var NNI469762067 = {kind: 1, offset: "r", len: 0, typ: NTI33554435, name: "r", sons: null};
NTI469762067.node = NNI469762067;
var NNI469762068 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "x", len: 0, typ: NTI33554435, name: "x", sons: null}, 
{kind: 1, offset: "y", len: 0, typ: NTI33554435, name: "y", sons: null}]};
NTI469762068.node = NNI469762068;
var NNI469762069 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "dx", len: 0, typ: NTI33554435, name: "dx", sons: null}, 
{kind: 1, offset: "dy", len: 0, typ: NTI33554435, name: "dy", sons: null}]};
NTI469762069.node = NNI469762069;
var NNI469762070 = {kind: 2, len: 0, offset: 0, typ: null, name: null, sons: []};
NTI469762070.node = NNI469762070;
var NNI469762071 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "ddx", len: 0, typ: NTI33554435, name: "ddx", sons: null}, 
{kind: 1, offset: "ddy", len: 0, typ: NTI33554435, name: "ddy", sons: null}]};
NTI469762071.node = NNI469762071;
var NNI469762072 = {kind: 1, offset: "coefficient", len: 0, typ: NTI33554435, name: "coefficient", sons: null};
NTI469762072.node = NNI469762072;
var NNI469762073 = {kind: 2, len: 0, offset: 0, typ: null, name: null, sons: []};
NTI469762073.node = NNI469762073;
NTI469764925.base = NTI469762190;
NTI469762198.base = NTI469762191;
NTI469762202.base = NTI469762067;
NTI469762206.base = NTI469762068;
NTI469762210.base = NTI469762069;
NTI469762214.base = NTI469762070;
NTI469762218.base = NTI469762071;
NTI469762222.base = NTI469762072;
NTI469762226.base = NTI469762073;
var NNI469762194 = {kind: 2, len: 10, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "nextID", len: 0, typ: NTI33554463, name: "nextID", sons: null}, 
{kind: 1, offset: "highestID", len: 0, typ: NTI33554463, name: "highestID", sons: null}, 
{kind: 1, offset: "signatureContainer", len: 0, typ: NTI469762198, name: "signatureContainer", sons: null}, 
{kind: 1, offset: "sizeContainer", len: 0, typ: NTI469762202, name: "sizeContainer", sons: null}, 
{kind: 1, offset: "positionContainer", len: 0, typ: NTI469762206, name: "positionContainer", sons: null}, 
{kind: 1, offset: "velocityContainer", len: 0, typ: NTI469762210, name: "velocityContainer", sons: null}, 
{kind: 1, offset: "bounceContainer", len: 0, typ: NTI469762214, name: "bounceContainer", sons: null}, 
{kind: 1, offset: "gravityContainer", len: 0, typ: NTI469762218, name: "gravityContainer", sons: null}, 
{kind: 1, offset: "dragContainer", len: 0, typ: NTI469762222, name: "dragContainer", sons: null}, 
{kind: 1, offset: "drawContainer", len: 0, typ: NTI469762226, name: "drawContainer", sons: null}]};
NTI469762194.node = NNI469762194;
NTI469762193.base = NTI469762194;
var NNI469762227 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469762227.node = NNI469762227;
var NNI33555124 = {kind: 2, len: 0, offset: 0, typ: null, name: null, sons: []};
NTI33555124.node = NNI33555124;
var NNI33555113 = {kind: 2, len: 0, offset: 0, typ: null, name: null, sons: []};
NTI33555113.node = NNI33555113;
NTI33555164.base = NTI33555112;
NTI33555165.base = NTI33555112;
var NNI33555112 = {kind: 2, len: 5, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "parent", len: 0, typ: NTI33555164, name: "parent", sons: null}, 
{kind: 1, offset: "name", len: 0, typ: NTI33554440, name: "name", sons: null}, 
{kind: 1, offset: "message", len: 0, typ: NTI33554439, name: "msg", sons: null}, 
{kind: 1, offset: "trace", len: 0, typ: NTI33554439, name: "trace", sons: null}, 
{kind: 1, offset: "up", len: 0, typ: NTI33555165, name: "up", sons: null}]};
NTI33555112.node = NNI33555112;
var NNI33555083 = {kind: 2, len: 0, offset: 0, typ: null, name: null, sons: []};
NTI33555083.node = NNI33555083;
NTI33555112.base = NTI33555083;
NTI33555113.base = NTI33555112;
NTI33555124.base = NTI33555113;
NTI469764927.base = NTI469762190;
NTI469764929.base = NTI469762190;
NTI469764931.base = NTI469762190;
NTI469764933.base = NTI469762190;
var NNI33555128 = {kind: 2, len: 0, offset: 0, typ: null, name: null, sons: []};
NTI33555128.node = NNI33555128;
NTI33555128.base = NTI33555113;
var NNI469762569 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469762569.node = NNI469762569;
var NNI469762734 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469762734.node = NNI469762734;
var NNI469762899 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469762899.node = NNI469762899;
var NNI469763064 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469763064.node = NNI469763064;
var NNI469763229 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469763229.node = NNI469763229;
var NNI469763394 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469763394.node = NNI469763394;
var NNI469763559 = {kind: 2, len: 2, offset: 0, typ: null, name: null, sons: [{kind: 1, offset: "Field0", len: 0, typ: NTI469762193, name: "Field0", sons: null}, 
{kind: 1, offset: "Field1", len: 0, typ: NTI33554463, name: "Field1", sons: null}]};
NTI469763559.node = NNI469763559;

function arrayConstr(len_33557180, value_33557181, typ_33557182) {
        var result = new Array(len_33557180);
    for (var i = 0; i < len_33557180; ++i) result[i] = nimCopy(null, value_33557181, typ_33557182);
    return result;
  

  
}

function setConstr() {
        var result = {};
    for (var i = 0; i < arguments.length; ++i) {
      var x = arguments[i];
      if (typeof(x) == "object") {
        for (var j = x[0]; j <= x[1]; ++j) {
          result[j] = true;
        }
      } else {
        result[x] = true;
      }
    }
    return result;
  

  
}
var ConstSet1 = setConstr(17, 16, 4, 18, 27, 19, 23, 22, 21);

function nimCopy(dest_33557141, src_33557142, ti_33557143) {
  var result_33557152 = null;

    switch (ti_33557143.kind) {
    case 21:
    case 22:
    case 23:
    case 5:
      if (!(isFatPointer_33557132(ti_33557143))) {
      result_33557152 = src_33557142;
      }
      else {
        result_33557152 = [src_33557142[0], src_33557142[1]];
      }
      
      break;
    case 19:
            if (dest_33557141 === null || dest_33557141 === undefined) {
        dest_33557141 = {};
      }
      else {
        for (var key in dest_33557141) { delete dest_33557141[key]; }
      }
      for (var key in src_33557142) { dest_33557141[key] = src_33557142[key]; }
      result_33557152 = dest_33557141;
    
      break;
    case 18:
    case 17:
      if (!((ti_33557143.base == null))) {
      result_33557152 = nimCopy(dest_33557141, src_33557142, ti_33557143.base);
      }
      else {
      if ((ti_33557143.kind == 17)) {
      result_33557152 = (dest_33557141 === null || dest_33557141 === undefined) ? {m_type: ti_33557143} : dest_33557141;
      }
      else {
        result_33557152 = (dest_33557141 === null || dest_33557141 === undefined) ? {} : dest_33557141;
      }
      }
      nimCopyAux(result_33557152, src_33557142, ti_33557143.node);
      break;
    case 24:
    case 4:
    case 27:
    case 16:
            if (src_33557142 === null) {
        result_33557152 = null;
      }
      else {
        if (dest_33557141 === null || dest_33557141 === undefined || dest_33557141.length != src_33557142.length) {
          dest_33557141 = new Array(src_33557142.length);
        }
        result_33557152 = dest_33557141;
        for (var i = 0; i < src_33557142.length; ++i) {
          result_33557152[i] = nimCopy(result_33557152[i], src_33557142[i], ti_33557143.base);
        }
      }
    
      break;
    case 28:
            if (src_33557142 !== null) {
        result_33557152 = src_33557142.slice(0);
      }
    
      break;
    default: 
      result_33557152 = src_33557142;
      break;
    }

  return result_33557152;

}
var ConstSet2 = setConstr(2, 3);

function SetLe(a_33556904, b_33556905) {
        for (var elem in a_33556904) { if (!b_33556905[elem]) return false; }
    return true;
  

  
}

function makeNimstrLit(c_33556802) {
      var result = [];
  for (var i = 0; i < c_33556802.length; ++i) {
    result[i] = c_33556802.charCodeAt(i);
  }
  return result;
  

  
}

function mnewString(len_33556894) {
        return new Array(len_33556894);
  

  
}

function toJSStr(s_33556808) {
                    var Temporary5;
            var Temporary7;

  var result_33556809 = null;

    var res_33556843 = newSeq_33556826((s_33556808).length);
    var i_33556844 = 0;
    var j_33556845 = 0;
    Label1: do {
        Label2: while (true) {
        if (!(i_33556844 < (s_33556808).length)) break Label2;
          var c_33556846 = s_33556808[i_33556844];
          if ((c_33556846 < 128)) {
          res_33556843[j_33556845] = String.fromCharCode(c_33556846);
          i_33556844 += 1;
          }
          else {
            var helper_33556858 = newSeq_33556826(0);
            Label3: do {
                Label4: while (true) {
                if (!true) break Label4;
                  var code_33556859 = c_33556846.toString(16);
                  if ((((code_33556859) == null ? 0 : (code_33556859).length) == 1)) {
                  helper_33556858.push("%0");;
                  }
                  else {
                  helper_33556858.push("%");;
                  }
                  
                  helper_33556858.push(code_33556859);;
                  i_33556844 += 1;
                    if (((s_33556808).length <= i_33556844)) Temporary5 = true; else {                      Temporary5 = (s_33556808[i_33556844] < 128);                    }                  if (Temporary5) {
                  break Label3;
                  }
                  
                  c_33556846 = s_33556808[i_33556844];
                }
            } while (false);
++excHandler;
            Temporary7 = framePtr;
            try {
            res_33556843[j_33556845] = decodeURIComponent(helper_33556858.join(""));
--excHandler;
} catch (EXCEPTION) {
 var prevJSError = lastJSError;
 lastJSError = EXCEPTION;
 --excHandler;
            framePtr = Temporary7;
            res_33556843[j_33556845] = helper_33556858.join("");
            lastJSError = prevJSError;
            } finally {
            framePtr = Temporary7;
            }
          }
          
          j_33556845 += 1;
        }
    } while (false);
    if (res_33556843.length < j_33556845) { for (var i = res_33556843.length ; i < j_33556845 ; ++i) res_33556843.push(null); }
               else { res_33556843.length = j_33556845; };
    result_33556809 = res_33556843.join("");

  return result_33556809;

}

function raiseException(e_33556668, ename_33556669) {
    e_33556668.name = ename_33556669;
    if ((excHandler == 0)) {
    unhandledException(e_33556668);
    }
    
    throw e_33556668;

  
}
var ConstSet3 = setConstr(2, 3, 4, 1);
var ConstSet4 = setConstr(2, 3, 5, 1);
var ConstSet5 = setConstr(2, 3, 6, 1);
var ConstSet6 = setConstr(2, 7, 1);
if (!Math.trunc) {
  Math.trunc = function(v) {
    v = +v;
    if (!isFinite(v)) return v;
    return (v - v % 1) || (v < 0 ? -0 : v === 0 ? v : 0);
  };
}

var objectID_637534370 = [0];

function isFatPointer_33557132(ti_33557133) {
  var result_33557134 = false;

  BeforeRet: do {
    result_33557134 = !((ConstSet1[ti_33557133.base.kind] != undefined));
    break BeforeRet;
  } while (false);

  return result_33557134;

}

function nimCopyAux(dest_33557145, src_33557146, n_33557147) {
    switch (n_33557147.kind) {
    case 0:
      break;
    case 1:
            dest_33557145[n_33557147.offset] = nimCopy(dest_33557145[n_33557147.offset], src_33557146[n_33557147.offset], n_33557147.typ);
    
      break;
    case 2:
          for (var i = 0; i < n_33557147.sons.length; i++) {
      nimCopyAux(dest_33557145, src_33557146, n_33557147.sons[i]);
    }
    
      break;
    case 3:
            dest_33557145[n_33557147.offset] = nimCopy(dest_33557145[n_33557147.offset], src_33557146[n_33557147.offset], n_33557147.typ);
      for (var i = 0; i < n_33557147.sons.length; ++i) {
        nimCopyAux(dest_33557145, src_33557146, n_33557147.sons[i][1]);
      }
    
      break;
    }

  
}

function newECS_469762309() {
  var result_469762310 = null;

    result_469762310 = ({nextID: 0, highestID: 0, signatureContainer: arrayConstr(100, {}, NTI469762191), sizeContainer: arrayConstr(100, ({r: 0.0}), NTI469762067), positionContainer: arrayConstr(100, ({x: 0.0, y: 0.0}), NTI469762068), velocityContainer: arrayConstr(100, ({dx: 0.0, dy: 0.0}), NTI469762069), bounceContainer: arrayConstr(100, ({}), NTI469762070), gravityContainer: arrayConstr(100, ({ddx: 0.0, ddy: 0.0}), NTI469762071), dragContainer: arrayConstr(100, ({coefficient: 0.0}), NTI469762072), drawContainer: arrayConstr(100, ({}), NTI469762073)});

  return result_469762310;

}
var width_469762071 = 360.0;
var height_469762072 = 360.0;
var ecs_469767303 = newECS_469762309();

function setup() {
    createCanvas(width_469762071, height_469762072);

  
}

function HEX2BHEX3D_872417266(x_872417268, x_872417268_Idx, y_872417269) {
    x_872417268[x_872417268_Idx] = (x_872417268[x_872417268_Idx] + y_872417269);

  
}

function getSignature_469762398(item_469762399) {
  var result_469762400 = {};

    result_469762400 = nimCopy(result_469762400, item_469762399["Field0"].signatureContainer[((item_469762399["Field1"]) | 0)], NTI469762191);

  return result_469762400;

}

function addChars_251658415(result_251658417, result_251658417_Idx, x_251658418, start_251658419, n_251658420) {
    var old_251658421 = (result_251658417[result_251658417_Idx]).length;
    (result_251658417[result_251658417_Idx].length = (old_251658421 + n_251658420));
    Label1: do {
      var iHEX60gensym4_251658435 = 0;
      var i_469767377 = 0;
      Label2: do {
          Label3: while (true) {
          if (!(i_469767377 < n_251658420)) break Label3;
            iHEX60gensym4_251658435 = i_469767377;
            result_251658417[result_251658417_Idx][(old_251658421 + iHEX60gensym4_251658435)] = x_251658418.charCodeAt((start_251658419 + iHEX60gensym4_251658435));
            i_469767377 += 1;
          }
      } while (false);
    } while (false);

  
}

function addChars_251658411(result_251658413, result_251658413_Idx, x_251658414) {
    addChars_251658415(result_251658413, result_251658413_Idx, x_251658414, 0, ((x_251658414) == null ? 0 : (x_251658414).length));

  
}

function addInt_251658436(result_251658437, result_251658437_Idx, x_251658438) {
    addChars_251658411(result_251658437, result_251658437_Idx, ((x_251658438) + ""));

  
}

function addInt_251658457(result_251658458, result_251658458_Idx, x_251658459) {
    addInt_251658436(result_251658458, result_251658458_Idx, x_251658459);

  
}

function HEX24_318767107(x_318767108) {
  var result_318767109 = [[]];

    addInt_251658457(result_318767109, 0, x_318767108);

  return result_318767109[0];

}

function HEX24_469762258(entity_469762259) {
  var result_469762260 = [];

    result_469762260 = nimCopy(null, HEX24_318767107(((entity_469762259) | 0)), NTI33554439);

  return result_469762260;

}

function inspect_469762454(ecs_469762455, entity_469762456) {
  var result_469762457 = [];

    result_469762457 = nimCopy(null, HEX24_469762258(entity_469762456), NTI33554439);

  return result_469762457;

}

function HEX24_469762461(item_469762462) {
  var result_469762463 = [];

    result_469762463 = nimCopy(null, inspect_469762454(item_469762462["Field0"], item_469762462["Field1"]), NTI33554439);

  return result_469762463;

}

function add_33556420(x_33556421, x_33556421_Idx, y_33556422) {
          if (x_33556421[x_33556421_Idx] === null) { x_33556421[x_33556421_Idx] = []; }
      var off = x_33556421[x_33556421_Idx].length;
      x_33556421[x_33556421_Idx].length += y_33556422.length;
      for (var i = 0; i < y_33556422.length; ++i) {
        x_33556421[x_33556421_Idx][off+i] = y_33556422.charCodeAt(i);
      }
    

  
}

function newSeq_33556826(len_33556828) {
  var result_33556829 = [];

    result_33556829 = new Array(len_33556828); for (var i = 0 ; i < len_33556828 ; ++i) { result_33556829[i] = null; }
  return result_33556829;

}

function unhandledException(e_33556664) {
    var buf_33556665 = [[]];
    if (!(((e_33556664.message).length == 0))) {
    buf_33556665[0].push.apply(buf_33556665[0], makeNimstrLit("Error: unhandled exception: "));;
    buf_33556665[0].push.apply(buf_33556665[0], e_33556664.message);;
    }
    else {
    buf_33556665[0].push.apply(buf_33556665[0], makeNimstrLit("Error: unhandled exception"));;
    }
    
    buf_33556665[0].push.apply(buf_33556665[0], makeNimstrLit(" ["));;
    add_33556420(buf_33556665, 0, e_33556664.name);
    buf_33556665[0].push.apply(buf_33556665[0], makeNimstrLit("]\x0A"));;
    var cbuf_33556666 = toJSStr(buf_33556665[0]);
    framePtr = null;
      if (typeof(Error) !== "undefined") {
    throw new Error(cbuf_33556666);
  }
  else {
    throw cbuf_33556666;
  }
  

  
}

function moveSystem_469765092(item_469765093) {
    var colontmp__469767372 = nimCopy(null, item_469765093, NTI469762227);
    var ecs_469765096 = colontmp__469767372["Field0"];
    var entity_469765097 = colontmp__469767372["Field1"];
    var oldPosition_469765151 = nimCopy(null, item_469765093.Field0.positionContainer[((item_469765093.Field1) | 0)], NTI469762068);
    HEX2BHEX3D_872417266(item_469765093.Field0.positionContainer[((item_469765093.Field1) | 0)], "y", item_469765093.Field0.velocityContainer[((item_469765093.Field1) | 0)].dy);
    if (!((getSignature_469762398(item_469765093)[2] != undefined))) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469765093) || [],makeNimstrLit("\' Does not have a component of type \'Position\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    if (!((getSignature_469762398(item_469765093)[3] != undefined))) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469765093) || [],makeNimstrLit("\' Does not have a component of type \'Velocity\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    HEX2BHEX3D_872417266(item_469765093["Field0"].positionContainer[((item_469765093["Field1"]) | 0)], "x", item_469765093["Field0"].velocityContainer[((item_469765093["Field1"]) | 0)].dx);

  
}

function bounceOnWalls_469765386(item_469765387) {
      var Temporary1;
      var Temporary2;

      if (((width_469762071 - item_469765387.Field0.sizeContainer[((item_469765387.Field1) | 0)].r) < item_469765387.Field0.positionContainer[((item_469765387.Field1) | 0)].x)) Temporary1 = true; else {        Temporary1 = (item_469765387.Field0.positionContainer[((item_469765387.Field1) | 0)].x < item_469765387.Field0.sizeContainer[((item_469765387.Field1) | 0)].r);      }    if (Temporary1) {
    item_469765387.Field0.velocityContainer[((item_469765387.Field1) | 0)].dx = -(item_469765387.Field0.velocityContainer[((item_469765387.Field1) | 0)].dx);
    }
    
      if (((height_469762072 - item_469765387.Field0.sizeContainer[((item_469765387.Field1) | 0)].r) < item_469765387.Field0.positionContainer[((item_469765387.Field1) | 0)].y)) Temporary2 = true; else {        Temporary2 = (item_469765387.Field0.positionContainer[((item_469765387.Field1) | 0)].y < item_469765387.Field0.sizeContainer[((item_469765387.Field1) | 0)].r);      }    if (Temporary2) {
    item_469765387.Field0.velocityContainer[((item_469765387.Field1) | 0)].dy = -(item_469765387.Field0.velocityContainer[((item_469765387.Field1) | 0)].dy);
    }
    

  
}

function fall_469766032(item_469766033) {
      var Temporary1;
      var Temporary2;

      if (((height_469762072 - item_469766033.Field0.sizeContainer[((item_469766033.Field1) | 0)].r) < item_469766033.Field0.positionContainer[((item_469766033.Field1) | 0)].y)) Temporary1 = true; else {        Temporary1 = (item_469766033.Field0.positionContainer[((item_469766033.Field1) | 0)].y < item_469766033.Field0.sizeContainer[((item_469766033.Field1) | 0)].r);      }    if (!(Temporary1)) {
    HEX2BHEX3D_872417266(item_469766033.Field0.velocityContainer[((item_469766033.Field1) | 0)], "dy", item_469766033.Field0.gravityContainer[((item_469766033.Field1) | 0)].ddy);
    }
    
      if (((width_469762071 - item_469766033.Field0.sizeContainer[((item_469766033.Field1) | 0)].r) < item_469766033.Field0.positionContainer[((item_469766033.Field1) | 0)].x)) Temporary2 = true; else {        Temporary2 = (item_469766033.Field0.positionContainer[((item_469766033.Field1) | 0)].x < item_469766033.Field0.sizeContainer[((item_469766033.Field1) | 0)].r);      }    if (!(Temporary2)) {
    HEX2BHEX3D_872417266(item_469766033.Field0.velocityContainer[((item_469766033.Field1) | 0)], "dx", item_469766033.Field0.gravityContainer[((item_469766033.Field1) | 0)].ddx);
    }
    

  
}

function abs_738197646(x_738197648) {
  var result_738197649 = 0.0;

    result_738197649 = Math.abs(x_738197648);

  return result_738197649;

}

function airResistance_469766686(item_469766687) {
    if ((0.0 < abs_738197646(item_469766687.Field0.velocityContainer[((item_469766687.Field1) | 0)].dy))) {
    item_469766687.Field0.velocityContainer[((item_469766687.Field1) | 0)].dy = (item_469766687.Field0.velocityContainer[((item_469766687.Field1) | 0)].dy * item_469766687.Field0.dragContainer[((item_469766687.Field1) | 0)].coefficient);
    }
    
    if ((0.0 < abs_738197646(item_469766687.Field0.velocityContainer[((item_469766687.Field1) | 0)].dx))) {
    item_469766687.Field0.velocityContainer[((item_469766687.Field1) | 0)].dx = (item_469766687.Field0.velocityContainer[((item_469766687.Field1) | 0)].dx * item_469766687.Field0.dragContainer[((item_469766687.Field1) | 0)].coefficient);
    }
    

  
}

function drawBall_469767128(item_469767129) {
    ellipse(item_469767129.Field0.positionContainer[((item_469767129.Field1) | 0)].x, item_469767129.Field0.positionContainer[((item_469767129.Field1) | 0)].y, (2.0 * item_469767129.Field0.sizeContainer[((item_469767129.Field1) | 0)].r));

  
}

function draw() {
    background(0);
    Label1: do {
      var itemHEX60gensym279_469767315 = 0;
      var actualQueryHEX60gensym69_469767338 = nimCopy(null, ConstSet2, NTI469764925);
      actualQueryHEX60gensym69_469767338[0] = true;
      Label2: do {
        var idHEX60gensym69_469767340 = 0;
        var colontmp__469767341 = 0;
        colontmp__469767341 = ((ecs_469767303.highestID) | 0);
        var res_469767342 = 0;
        Label3: do {
            Label4: while (true) {
            if (!(res_469767342 <= colontmp__469767341)) break Label4;
              idHEX60gensym69_469767340 = res_469767342;
              if (SetLe(actualQueryHEX60gensym69_469767338, ecs_469767303.signatureContainer[idHEX60gensym69_469767340])) {
              itemHEX60gensym279_469767315 = idHEX60gensym69_469767340;
              var itemHEX60gensym279_469767316 = nimCopy(null, {Field0: ecs_469767303, Field1: itemHEX60gensym279_469767315}, NTI469762227);
              moveSystem_469765092(itemHEX60gensym279_469767316);
              }
              
              res_469767342 += 1;
            }
        } while (false);
      } while (false);
    } while (false);
    Label5: do {
      var itemHEX60gensym280_469767319 = 0;
      var actualQueryHEX60gensym69_469767345 = nimCopy(null, ConstSet3, NTI469764927);
      actualQueryHEX60gensym69_469767345[0] = true;
      Label6: do {
        var idHEX60gensym69_469767347 = 0;
        var colontmp__469767348 = 0;
        colontmp__469767348 = ((ecs_469767303.highestID) | 0);
        var res_469767349 = 0;
        Label7: do {
            Label8: while (true) {
            if (!(res_469767349 <= colontmp__469767348)) break Label8;
              idHEX60gensym69_469767347 = res_469767349;
              if (SetLe(actualQueryHEX60gensym69_469767345, ecs_469767303.signatureContainer[idHEX60gensym69_469767347])) {
              itemHEX60gensym280_469767319 = idHEX60gensym69_469767347;
              var itemHEX60gensym280_469767320 = nimCopy(null, {Field0: ecs_469767303, Field1: itemHEX60gensym280_469767319}, NTI469762227);
              bounceOnWalls_469765386(itemHEX60gensym280_469767320);
              }
              
              res_469767349 += 1;
            }
        } while (false);
      } while (false);
    } while (false);
    Label9: do {
      var itemHEX60gensym281_469767323 = 0;
      var actualQueryHEX60gensym69_469767352 = nimCopy(null, ConstSet4, NTI469764929);
      actualQueryHEX60gensym69_469767352[0] = true;
      Label10: do {
        var idHEX60gensym69_469767354 = 0;
        var colontmp__469767355 = 0;
        colontmp__469767355 = ((ecs_469767303.highestID) | 0);
        var res_469767356 = 0;
        Label11: do {
            Label12: while (true) {
            if (!(res_469767356 <= colontmp__469767355)) break Label12;
              idHEX60gensym69_469767354 = res_469767356;
              if (SetLe(actualQueryHEX60gensym69_469767352, ecs_469767303.signatureContainer[idHEX60gensym69_469767354])) {
              itemHEX60gensym281_469767323 = idHEX60gensym69_469767354;
              var itemHEX60gensym281_469767324 = nimCopy(null, {Field0: ecs_469767303, Field1: itemHEX60gensym281_469767323}, NTI469762227);
              fall_469766032(itemHEX60gensym281_469767324);
              }
              
              res_469767356 += 1;
            }
        } while (false);
      } while (false);
    } while (false);
    Label13: do {
      var itemHEX60gensym282_469767327 = 0;
      var actualQueryHEX60gensym69_469767359 = nimCopy(null, ConstSet5, NTI469764931);
      actualQueryHEX60gensym69_469767359[0] = true;
      Label14: do {
        var idHEX60gensym69_469767361 = 0;
        var colontmp__469767362 = 0;
        colontmp__469767362 = ((ecs_469767303.highestID) | 0);
        var res_469767363 = 0;
        Label15: do {
            Label16: while (true) {
            if (!(res_469767363 <= colontmp__469767362)) break Label16;
              idHEX60gensym69_469767361 = res_469767363;
              if (SetLe(actualQueryHEX60gensym69_469767359, ecs_469767303.signatureContainer[idHEX60gensym69_469767361])) {
              itemHEX60gensym282_469767327 = idHEX60gensym69_469767361;
              var itemHEX60gensym282_469767328 = nimCopy(null, {Field0: ecs_469767303, Field1: itemHEX60gensym282_469767327}, NTI469762227);
              airResistance_469766686(itemHEX60gensym282_469767328);
              }
              
              res_469767363 += 1;
            }
        } while (false);
      } while (false);
    } while (false);
    Label17: do {
      var itemHEX60gensym284_469767331 = 0;
      var actualQueryHEX60gensym69_469767366 = nimCopy(null, ConstSet6, NTI469764933);
      actualQueryHEX60gensym69_469767366[0] = true;
      Label18: do {
        var idHEX60gensym69_469767368 = 0;
        var colontmp__469767369 = 0;
        colontmp__469767369 = ((ecs_469767303.highestID) | 0);
        var res_469767370 = 0;
        Label19: do {
            Label20: while (true) {
            if (!(res_469767370 <= colontmp__469767369)) break Label20;
              idHEX60gensym69_469767368 = res_469767370;
              if (SetLe(actualQueryHEX60gensym69_469767366, ecs_469767303.signatureContainer[idHEX60gensym69_469767368])) {
              itemHEX60gensym284_469767331 = idHEX60gensym69_469767368;
              var itemHEX60gensym284_469767332 = nimCopy(null, {Field0: ecs_469767303, Field1: itemHEX60gensym284_469767331}, NTI469762227);
              drawBall_469767128(itemHEX60gensym284_469767332);
              }
              
              res_469767370 += 1;
            }
        } while (false);
      } while (false);
    } while (false);

  
}
var ballId_469767381 = [1];

function max_469762537(x_469762539, y_469762540) {
    var Temporary1;

  var result_469762541 = 0;

    if ((y_469762540 <= x_469762539)) {
    Temporary1 = x_469762539;
    }
    else {
    Temporary1 = y_469762540;
    }
    
    result_469762541 = Temporary1;

  return result_469762541;

}

function newEntity_469762464(ecs_469762465, labelHEX60gensym39_469762466) {
  var result_469762467 = 0;

    var newIdHEX60gensym39_469762468 = -1;
    Label1: do {
      var idHEX60gensym39_469762477 = 0;
      var colontmp__469767402 = 0;
      colontmp__469767402 = ((ecs_469762465.nextID) | 0);
      var res_469767403 = colontmp__469767402;
      Label2: do {
          Label3: while (true) {
          if (!(res_469767403 <= 99)) break Label3;
            idHEX60gensym39_469762477 = res_469767403;
            if (!((ecs_469762465.signatureContainer[idHEX60gensym39_469762477][0] != undefined))) {
            newIdHEX60gensym39_469762468 = idHEX60gensym39_469762477;
            break Label1;
            }
            
            res_469767403 += 1;
          }
      } while (false);
    } while (false);
    if ((newIdHEX60gensym39_469762468 < 0)) {
    raiseException({message: (makeNimstrLit("Tried to instantiate Entity \'") || []).concat(labelHEX60gensym39_469762466 || [],makeNimstrLit("\' but ran out of ID:s. You can increase the number of supported entities by supplying \'ECSConfig(maxEntities: <int>)\' to \'createECS()\'") || []), parent: null, m_type: NTI33555128, name: null, trace: [], up: null}, "IndexDefect");
    }
    
    result_469762467 = newIdHEX60gensym39_469762468;
    ecs_469762465.nextID = ((ecs_469762465.nextID + 1) & 0xffff);
    ecs_469762465.highestID = max_469762537(result_469762467, ecs_469762465.highestID);
    ecs_469762465.signatureContainer[newIdHEX60gensym39_469762468][0] = true;

  return result_469762467;

}

function addComponent_469762944(item_469762945, size_469762946) {
    if ((getSignature_469762398(item_469762945)[1] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469762945) || [],makeNimstrLit("\' Already has a component of type \'Size\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767405 = nimCopy(null, item_469762945, NTI469762569);
    var ecs_469762952 = colontmp__469767405["Field0"];
    var entity_469762953 = colontmp__469767405["Field1"];
    ecs_469762952.sizeContainer[((entity_469762953) | 0)] = nimCopy(ecs_469762952.sizeContainer[((entity_469762953) | 0)], size_469762946, NTI469762067);
    ecs_469762952.signatureContainer[((entity_469762953) | 0)][1] = true;

  
}

function addComponent_469763238(item_469763239, position_469763240) {
    if ((getSignature_469762398(item_469763239)[2] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469763239) || [],makeNimstrLit("\' Already has a component of type \'Position\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767406 = nimCopy(null, item_469763239, NTI469762734);
    var ecs_469763246 = colontmp__469767406["Field0"];
    var entity_469763247 = colontmp__469767406["Field1"];
    ecs_469763246.positionContainer[((entity_469763247) | 0)] = nimCopy(ecs_469763246.positionContainer[((entity_469763247) | 0)], position_469763240, NTI469762068);
    ecs_469763246.signatureContainer[((entity_469763247) | 0)][2] = true;

  
}

function addComponent_469763532(item_469763533, velocity_469763534) {
    if ((getSignature_469762398(item_469763533)[3] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469763533) || [],makeNimstrLit("\' Already has a component of type \'Velocity\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767407 = nimCopy(null, item_469763533, NTI469762899);
    var ecs_469763540 = colontmp__469767407["Field0"];
    var entity_469763541 = colontmp__469767407["Field1"];
    ecs_469763540.velocityContainer[((entity_469763541) | 0)] = nimCopy(ecs_469763540.velocityContainer[((entity_469763541) | 0)], velocity_469763534, NTI469762069);
    ecs_469763540.signatureContainer[((entity_469763541) | 0)][3] = true;

  
}

function addComponent_469763826(item_469763827, bounce_469763828) {
    if ((getSignature_469762398(item_469763827)[4] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469763827) || [],makeNimstrLit("\' Already has a component of type \'Bounce\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767408 = nimCopy(null, item_469763827, NTI469763064);
    var ecs_469763834 = colontmp__469767408["Field0"];
    var entity_469763835 = colontmp__469767408["Field1"];
    ecs_469763834.bounceContainer[((entity_469763835) | 0)] = nimCopy(ecs_469763834.bounceContainer[((entity_469763835) | 0)], bounce_469763828, NTI469762070);
    ecs_469763834.signatureContainer[((entity_469763835) | 0)][4] = true;

  
}

function addComponent_469764120(item_469764121, gravity_469764122) {
    if ((getSignature_469762398(item_469764121)[5] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469764121) || [],makeNimstrLit("\' Already has a component of type \'Gravity\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767409 = nimCopy(null, item_469764121, NTI469763229);
    var ecs_469764128 = colontmp__469767409["Field0"];
    var entity_469764129 = colontmp__469767409["Field1"];
    ecs_469764128.gravityContainer[((entity_469764129) | 0)] = nimCopy(ecs_469764128.gravityContainer[((entity_469764129) | 0)], gravity_469764122, NTI469762071);
    ecs_469764128.signatureContainer[((entity_469764129) | 0)][5] = true;

  
}

function addComponent_469764414(item_469764415, drag_469764416) {
    if ((getSignature_469762398(item_469764415)[6] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469764415) || [],makeNimstrLit("\' Already has a component of type \'Drag\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767410 = nimCopy(null, item_469764415, NTI469763394);
    var ecs_469764422 = colontmp__469767410["Field0"];
    var entity_469764423 = colontmp__469767410["Field1"];
    ecs_469764422.dragContainer[((entity_469764423) | 0)] = nimCopy(ecs_469764422.dragContainer[((entity_469764423) | 0)], drag_469764416, NTI469762072);
    ecs_469764422.signatureContainer[((entity_469764423) | 0)][6] = true;

  
}

function addComponent_469764708(item_469764709, draw_469764710) {
    if ((getSignature_469762398(item_469764709)[7] != undefined)) {
    raiseException({message: (makeNimstrLit("Entity \'") || []).concat(HEX24_469762461(item_469764709) || [],makeNimstrLit("\' Already has a component of type \'Draw\'") || []), parent: null, m_type: NTI33555124, name: null, trace: [], up: null}, "AssertionDefect");
    }
    
    var colontmp__469767411 = nimCopy(null, item_469764709, NTI469763559);
    var ecs_469764716 = colontmp__469767411["Field0"];
    var entity_469764717 = colontmp__469767411["Field1"];
    ecs_469764716.drawContainer[((entity_469764717) | 0)] = nimCopy(ecs_469764716.drawContainer[((entity_469764717) | 0)], draw_469764710, NTI469762073);
    ecs_469764716.signatureContainer[((entity_469764717) | 0)][7] = true;

  
}

function newBall_469767382(r_469767383, x_469767384, y_469767385, dx_469767386, dy_469767387, ddx_469767388, ddy_469767389, bounce_469767390, gravity_469767391, drag_469767392, coeff_469767393) {
  var result_469767394 = 0;

    var ball_469767395 = newEntity_469762464(ecs_469767303, (makeNimstrLit("ball ") || []).concat(HEX24_318767107(ballId_469767381[0]) || []));
    var item_469767396 = {Field0: ecs_469767303, Field1: ball_469767395};
    addComponent_469762944(item_469767396, {r: r_469767383});
    addComponent_469763238(item_469767396, {x: x_469767384, y: y_469767385});
    addComponent_469763532(item_469767396, {dx: dx_469767386, dy: dy_469767387});
    if (bounce_469767390) {
    addComponent_469763826(item_469767396, {});
    }
    
    if (gravity_469767391) {
    addComponent_469764120(item_469767396, {ddx: ddx_469767388, ddy: ddy_469767389});
    }
    
    if (drag_469767392) {
    addComponent_469764414(item_469767396, {coefficient: coeff_469767393});
    }
    
    addComponent_469764708(item_469767396, {});
    result_469767394 = ball_469767395;

  return result_469767394;

}
var ball1_469767397 = newBall_469767382(15.0, 50.0, 180.0, -2.0, 1.0, 0.0, 0.0, true, false, false, 1.0);
var ball2_469767398 = newBall_469767382(10.0, 10.0, 60.0, 4.0, 0.0, 0.0, -1.0, true, true, false, 1.0);
var ball3_469767399 = newBall_469767382(7.0, 180.0, 180.0, 5.0, 2.0, 0.3, 0.5, true, true, false, 1.0);
var ball4_469767400 = newBall_469767382(20.0, 240.0, 40.0, -15.0, 0.0, 0.0, 0.5, true, true, true, 0.99);
</script>
</main>
<footer>
<hr>
<div class="nb-box">
  <span><span class="nb-small">made with <a href="https://pietroppeter.github.io/nimib/">nimib üê≥</a></span></span>
  <span></span>
  <span><button class="nb-small" id="show" onclick="toggleSourceDisplay()">Show Source</button></span>
</div>
</footer>
<section id="source">
<pre><code class="nim hljs"><span class="hljs-keyword">import</span> nimib
nbInit
setCurrentDir nb.thisDir
nbRawHtml:
  <span class="hljs-string">&quot;&quot;&quot;&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js&quot; integrity=&quot;sha512-rCZdHNB0AePry6kAnKAVFMRfWPmUXSo+/vlGtrOUvhsxD0Punm/xWbEh+8vppPIOzKB9xnk42yCRZ5MD/jvvjQ==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;&quot;&quot;&quot;</span>
nbText: <span class="hljs-string">&quot;&quot;&quot;## Bouncing balls with an ECS
Yesterday (Nov 14th 2022) I went to a very nice meetup
here in Milan ([Open Source Saturday Milano](https://www.meetup.com/it-IT/open-source-saturday-milano/)).
You go there and you propose what you want to work on (some Open Source related activity).
People might be curious and tag along, or you might be interested in what others are doing.

I went with the idea of exploring Entity Component Systems (ECS), something I had never played with.
Initially the idea was to use [polymorph].
I wanted to try and see if I was able to make it work with Nim's js backend.
Unfortunately it appears polymorph has [some kind of issue with js backend](https://github.com/rlipsc/polymorph/issues/21),
so the two poor souls that were curious about Nim, saw me fail miserably in the task
and generously helped debugging
(of course it took a while to understand the issue was with polymorph and not with the code I was writing).
At the end of morning I pivoted to try using [EasyEss](https://github.com/EriKWDev/easyess),
a polymorph's inspired ECS by the author of [Nanim](https://github.com/EriKWDev/nanim).
Indeed EasyEss works with Nim's js backend so the day was saved!

Today I managed to complete a very small demo.
Code is not really cleaned up and it is the first time I play with an ECS.
For drawing to canvas it uses code from [bouncing_ball_p5js](bouncing_ball_p5js.html),
but probably a better option would be to use something like [jscanvas](https://github.com/planetis-m/jscanvas).

To test the different components/systems I am showing 4 balls:
- one ball bounces with gravity directed towards the roof
- a smaller ball bounces with gravity directed approximately towards the bottom right corner
- a bigger ball does not feel gravity and slowly drifts bouncing off the walls
- the biggest ball is subject to drag and stops after a few bounces
  - drag acts a bit weird when bouncing close to the walls
- the balls do not interact with each other

To see the code, click on Show source button in the bottom right corner of the page.

[polymorph]: https://github.com/rlipsc/polymorph
&quot;&quot;&quot;</span>
nbJsFromCode:
  <span class="hljs-keyword">import</span> easyess
  <span class="hljs-keyword">import</span> p5, std / lenientops

  <span class="hljs-keyword">let</span>
    width = <span class="hljs-number">360.0</span>
    height = <span class="hljs-number">360.0</span>

  comp:
    <span class="hljs-keyword">type</span>
      <span class="hljs-type">Size</span> = <span class="hljs-keyword">object</span>
        r: <span class="hljs-built_in">float</span>

      <span class="hljs-type">Position</span> = <span class="hljs-keyword">object</span>
        x: <span class="hljs-built_in">float</span>
        y: <span class="hljs-built_in">float</span>

      <span class="hljs-type">Velocity</span> = <span class="hljs-keyword">object</span>
        dx: <span class="hljs-built_in">float</span>
        dy: <span class="hljs-built_in">float</span>

      <span class="hljs-type">Bounce</span> = <span class="hljs-keyword">object</span>

      <span class="hljs-type">Gravity</span> = <span class="hljs-keyword">object</span>
        ddx: <span class="hljs-built_in">float</span>
        ddy: <span class="hljs-built_in">float</span>

      <span class="hljs-type">Drag</span> = <span class="hljs-keyword">object</span>
        coefficient: <span class="hljs-built_in">float</span>

      <span class="hljs-type">Draw</span> = <span class="hljs-keyword">object</span>


  <span class="hljs-keyword">const</span>
    systemsGroup = <span class="hljs-string">&quot;systems&quot;</span>
    renderingGroup = <span class="hljs-string">&quot;rendering&quot;</span>

  sys [<span class="hljs-type">Position</span>, vel: <span class="hljs-type">Velocity</span>], systemsGroup:
    <span class="hljs-keyword">func</span> moveSystem(item: <span class="hljs-type">Item</span>) =
      <span class="hljs-keyword">let</span>
        (ecs, entity) = item
        oldPosition = position

      position.y += vel.dy
      item.position.x += item.velocity.dx

      <span class="hljs-keyword">when</span> <span class="hljs-keyword">defined</span>(debugMove):
        debugEcho <span class="hljs-string">&quot;Moved &quot;</span> &amp; ecs.inspect(entity) &amp; <span class="hljs-string">&quot; from &quot;</span>, oldPosition, <span class="hljs-string">&quot; to &quot;</span>, position

  sys [pos: <span class="hljs-type">Position</span>, vel: <span class="hljs-type">Velocity</span>, <span class="hljs-type">Bounce</span>, <span class="hljs-type">Size</span>], systemsGroup:
    <span class="hljs-keyword">proc</span> bounceOnWalls(item: <span class="hljs-type">Item</span>) =
      <span class="hljs-keyword">if</span> pos.x &gt; width - size.r <span class="hljs-keyword">or</span> pos.x &lt; size.r:
        vel.dx = -vel.dx
      <span class="hljs-keyword">if</span> pos.y &gt; height - size.r <span class="hljs-keyword">or</span> pos.y &lt; size.r:
        vel.dy = -vel.dy

  sys [pos: <span class="hljs-type">Position</span>, vel: <span class="hljs-type">Velocity</span>, <span class="hljs-type">Gravity</span>, <span class="hljs-type">Size</span>], systemsGroup:
    <span class="hljs-keyword">proc</span> fall(item: <span class="hljs-type">Item</span>) =
      <span class="hljs-comment"># apply gravity only if not falling</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (pos.y &gt; height - size.r <span class="hljs-keyword">or</span> pos.y &lt; size.r):
        vel.dy += gravity.ddy
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (pos.x &gt; width - size.r <span class="hljs-keyword">or</span> pos.x &lt; size.r):
        vel.dx += gravity.ddx

  sys [pos: <span class="hljs-type">Position</span>, vel: <span class="hljs-type">Velocity</span>, <span class="hljs-type">Drag</span>, <span class="hljs-type">Size</span>], systemsGroup:
    <span class="hljs-keyword">proc</span> airResistance(item: <span class="hljs-type">Item</span>) =
      <span class="hljs-keyword">if</span> abs(vel.dy) &gt; <span class="hljs-number">0</span>:
        vel.dy = vel.dy*drag.coefficient
      <span class="hljs-keyword">if</span> abs(vel.dx) &gt; <span class="hljs-number">0</span>:
        vel.dx = vel.dx*drag.coefficient


  sys [<span class="hljs-type">Position</span>, <span class="hljs-type">Draw</span>, <span class="hljs-type">Size</span>], renderingGroup:
    <span class="hljs-keyword">proc</span> drawBall(item: <span class="hljs-type">Item</span>) =
      ellipse(position.x, position.y, <span class="hljs-number">2</span>*size.r)


  createECS(<span class="hljs-type">ECSConfig</span>(maxEntities: <span class="hljs-number">100</span>))

  <span class="hljs-keyword">let</span>
    ecs = newECS()

  <span class="hljs-keyword">proc</span> setup() {. exportc .} =
    createCanvas(width, height)

  <span class="hljs-keyword">proc</span> draw() {. exportc .} =
    background(<span class="hljs-number">0</span>)
    ecs.runSystems()
    ecs.runRendering()

  <span class="hljs-keyword">var</span> ballId = <span class="hljs-number">1</span>

  <span class="hljs-keyword">proc</span> newBall(r, x, y, dx, dy, ddx, ddy: <span class="hljs-built_in">float</span>; bounce, gravity, drag = <span class="hljs-literal">false</span>, coeff = <span class="hljs-number">1.0</span>): <span class="hljs-built_in">auto</span> =
    <span class="hljs-keyword">let</span>
      ball = ecs.newEntity(<span class="hljs-string">&quot;ball &quot;</span> &amp; $ballId)
      item = (ecs, ball)

    item.addComponent(<span class="hljs-type">Size</span>(r: r))
    item.addComponent(<span class="hljs-type">Position</span>(x: x, y: y))
    item.addComponent(<span class="hljs-type">Velocity</span>(dx: dx, dy: dy))
    <span class="hljs-keyword">if</span> bounce:
      item.addComponent(<span class="hljs-type">Bounce</span>())
    <span class="hljs-keyword">if</span> gravity:
      item.addComponent(<span class="hljs-type">Gravity</span>(ddx: ddx, ddy: ddy))
    <span class="hljs-keyword">if</span> drag:
      item.addComponent(<span class="hljs-type">Drag</span>(coefficient: coeff))
    item.addComponent(<span class="hljs-type">Draw</span>())

    <span class="hljs-literal">result</span> = ball

  <span class="hljs-keyword">let</span>
    ball1 = newBall(<span class="hljs-number">15.0</span>, <span class="hljs-number">50.0</span>, <span class="hljs-number">180.0</span>, -<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>)
    ball2 = newBall(<span class="hljs-number">10.0</span>, <span class="hljs-number">10.0</span>, <span class="hljs-number">60.0</span>, <span class="hljs-number">4.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, -<span class="hljs-number">1.0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)
    ball3 = newBall(<span class="hljs-number">7.0</span>, <span class="hljs-number">180.0</span>, <span class="hljs-number">180.0</span>, <span class="hljs-number">5.0</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.5</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)
    ball4 = newBall(<span class="hljs-number">20.0</span>, <span class="hljs-number">240.0</span>, <span class="hljs-number">40.0</span>, -<span class="hljs-number">15.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.5</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">0.99</span>)

setCurrentDir nb.initDir
nbSave
</code></pre>
</section><script>
function toggleSourceDisplay() {
  var btn = document.getElementById("show")
  var source = document.getElementById("source");
  if (btn.innerHTML=="Show Source") {
    btn.innerHTML = "Hide Source";
    source.style.display = "block";
  } else {
    btn.innerHTML = "Show Source";
    source.style.display = "none";
  }
}
</script></body>
</html>